# docker build -t wenex/platform:latest .
x-common: &common
  image: wenex/platform:latest
  env_file:
    - .env
  networks:
    - localnet

x-env: &env
  KAFKA_HOST: kafka
  KAFKA_PORT: 9093
  REDIS_HOST: redis
  MINIO_HOST: minio
  EMQX_BASE_URL: http://192.168.1.17:18083/api/v5 # HOST
  EMQX_EXHOOK_URL: http://platform-preserver:6030

services:
  gateway:
    profiles:
      - gateway
      - platform
    container_name: platform-gateway
    ports:
      - 3010:3010 # Rest
    environment:
      SERVICE_NAME: gateway
      <<: *env
    <<: *common

  auth:
    profiles:
      - auth
      - platform
    container_name: platform-auth
    ports:
      - 3020:3020 # Rest
      - 5020:5020 # gRPC
    environment:
      SERVICE_NAME: auth
      <<: *env
    <<: *common

  domain:
    profiles:
      - domain
      - platform
    container_name: platform-domain
    ports:
      - 3030:3030 # Rest
      - 5030:5030 # gRPC
    environment:
      SERVICE_NAME: domain
      <<: *env
    <<: *common

  context:
    profiles:
      - context
      - platform
    container_name: platform-context
    ports:
      - 3040:3040 # Rest
      - 5040:5040 # gRPC
    environment:
      SERVICE_NAME: context
      <<: *env
    <<: *common

  essential:
    profiles:
      - essential
      - platform
    container_name: platform-essential
    ports:
      - 3050:3050 # Rest
      - 5050:5050 # gRPC
    environment:
      SERVICE_NAME: essential
      <<: *env
    <<: *common

  # ---------
  # Commands
  # ---------

  db-clean:
    profiles:
      - db-clean
    entrypoint: ['bash', '-c', 'npm run db:clean']
    environment:
      <<: *env
    <<: *common

  db-seed:
    profiles:
      - db-seed
    entrypoint: ['bash', '-c', 'npm run db:seed']
    environment:
      <<: *env
    <<: *common

  storage-init:
    profiles:
      - storage-init
    entrypoint: ['bash', '-c', 'npm run storage:init']
    environment:
      <<: *env
    <<: *common

  utility-init:
    profiles:
      - utility-init
    entrypoint: ['bash', '-c', 'npm run utility:init']
    environment:
      <<: *env
    <<: *common

  kafka-connect:
    profiles:
      - kafka-connect
    entrypoint: ['bash', '-c', 'npm run script:kafka-connect']
    environment:
      <<: *env
    <<: *common

networks:
  localnet:
    driver: bridge
    name: wenex-network
